const hre = require("hardhat");

// MNEE Token address on Ethereum mainnet
const MNEE_TOKEN_ADDRESS = "0x8ccedbAe4916b79da7F3F612EfB2EB93A2bFD6cF";

async function main() {
  console.log("ðŸš€ Starting VaultLink contract deployment...\n");

  const [deployer] = await hre.ethers.getSigners();
  console.log("ðŸ“ Deploying contracts with account:", deployer.address);
  console.log("ðŸ’° Account balance:", hre.ethers.formatEther(await hre.ethers.provider.getBalance(deployer.address)), "ETH\n");

  // Deploy ContentVault
  console.log("ðŸ“¦ Deploying ContentVault...");
  const ContentVault = await hre.ethers.getContractFactory("ContentVault");
  const contentVault = await ContentVault.deploy(MNEE_TOKEN_ADDRESS);
  await contentVault.waitForDeployment();
  const contentVaultAddress = await contentVault.getAddress();
  console.log("âœ… ContentVault deployed to:", contentVaultAddress);

  // Deploy RevenueStreamer
  console.log("\nðŸ“¦ Deploying RevenueStreamer...");
  const RevenueStreamer = await hre.ethers.getContractFactory("RevenueStreamer");
  const revenueStreamer = await RevenueStreamer.deploy(MNEE_TOKEN_ADDRESS);
  await revenueStreamer.waitForDeployment();
  const revenueStreamerAddress = await revenueStreamer.getAddress();
  console.log("âœ… RevenueStreamer deployed to:", revenueStreamerAddress);

  // Deploy SplitPayment
  console.log("\nðŸ“¦ Deploying SplitPayment...");
  const SplitPayment = await hre.ethers.getContractFactory("SplitPayment");
  const splitPayment = await SplitPayment.deploy(MNEE_TOKEN_ADDRESS);
  await splitPayment.waitForDeployment();
  const splitPaymentAddress = await splitPayment.getAddress();
  console.log("âœ… SplitPayment deployed to:", splitPaymentAddress);

  // Summary
  console.log("\n" + "=".repeat(60));
  console.log("ðŸŽ‰ DEPLOYMENT COMPLETE!");
  console.log("=".repeat(60));
  console.log("\nðŸ“‹ Contract Addresses:");
  console.log("   MNEE Token:        ", MNEE_TOKEN_ADDRESS);
  console.log("   ContentVault:      ", contentVaultAddress);
  console.log("   RevenueStreamer:   ", revenueStreamerAddress);
  console.log("   SplitPayment:      ", splitPaymentAddress);
  
  console.log("\nðŸ“ Add these to your .env.local:");
  console.log(`NEXT_PUBLIC_CONTENT_VAULT_ADDRESS=${contentVaultAddress}`);
  console.log(`NEXT_PUBLIC_REVENUE_STREAMER_ADDRESS=${revenueStreamerAddress}`);
  console.log(`NEXT_PUBLIC_SPLIT_PAYMENT_ADDRESS=${splitPaymentAddress}`);

  // Verify contracts on Etherscan (if not localhost)
  if (hre.network.name !== "hardhat" && hre.network.name !== "localhost") {
    console.log("\nâ³ Waiting 30 seconds before verification...");
    await new Promise(resolve => setTimeout(resolve, 30000));

    console.log("\nðŸ” Verifying contracts on Etherscan...");
    
    try {
      await hre.run("verify:verify", {
        address: contentVaultAddress,
        constructorArguments: [MNEE_TOKEN_ADDRESS],
      });
      console.log("âœ… ContentVault verified");
    } catch (error) {
      console.log("âŒ ContentVault verification failed:", error.message);
    }

    try {
      await hre.run("verify:verify", {
        address: revenueStreamerAddress,
        constructorArguments: [MNEE_TOKEN_ADDRESS],
      });
      console.log("âœ… RevenueStreamer verified");
    } catch (error) {
      console.log("âŒ RevenueStreamer verification failed:", error.message);
    }

    try {
      await hre.run("verify:verify", {
        address: splitPaymentAddress,
        constructorArguments: [MNEE_TOKEN_ADDRESS],
      });
      console.log("âœ… SplitPayment verified");
    } catch (error) {
      console.log("âŒ SplitPayment verification failed:", error.message);
    }
  }

  console.log("\n" + "=".repeat(60));
  console.log("âœ¨ Deployment script completed successfully!");
  console.log("=".repeat(60) + "\n");
}

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error(error);
    process.exit(1);
  });
